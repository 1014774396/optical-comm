%
clear, clc, close all

addpath ../f/
addpath ../../f/

Qpsk = QAM(4, 2*112e9);
sim.ModFormat = Qpsk;
BERtarget = 1.8e-4;
sim.BERtarget = BERtarget;
totalLinewidth = 2e3*(0:100:1e3);
Delay = 400e-12;
csi = sqrt(2)/2;
q = 1.60217662e-19;

for Ncpr = 1:2
    for k = 1:length(totalLinewidth)
        [wnOpt(Ncpr, k), ~, SNRdB] = optimizePLL(csi, Delay, totalLinewidth(k), Ncpr, sim, true);
        
        % PrxrefdBm = 10*log10(10^(SNRdB/10)*2*q*Qpsk.Rs/1e-3)

        [SNRdBpen, ~, exitflag] = fzero(@(SNRdB)...
            log10(ber_qpsk_imperfect_cpr(SNRdB, phase_error_variance(csi, wnOpt(Ncpr, k), Ncpr, Delay, totalLinewidth(k), SNRdB, Qpsk.Rs))) - log10(BERtarget), SNRdB);
        
        if exitflag ~= 1
            warning('SNRdB calculation finished with exitflag = %d', exitflag);
        end
        
        PrxreqdBm(Ncpr, k) = 10*log10(10^(SNRdBpen/10)*2*q*Qpsk.Rs/1e-3);
    end
end

%% BERtarget = 1e-3
% PrxreqdBm_sim_1pol_200ps = [-35.0638475477122,-34.8768314796697,-34.8978641468983,-34.7251661222600,-34.7461890566855,-34.6214280487728,-34.5443377366734,-34.4638808470772,-34.4590436579059,-34.3903514825488,-34.2591701118987;-35.0638475477122,-34.9598221340235,-34.9786580903368,-34.8191154208883,-34.7916436011492,-34.6873557228309,-34.6016647223014,-34.6262416146221,-34.6263789826399,-34.5830337572283,-34.5240961729356];
% PrxreqdBm_sim_2pol_200ps = [-35.0638475477122,-34.8622583445509,-34.7849660051915,-34.7345016989127,-34.5445802999749,-34.5260878673442,-34.4030302511419,-34.3645502157166,-34.4180879996068,-34.1696107868148,-34.1141046006832;-35.0638475477122,-34.9563731930230,-34.9885430657636,-34.8752141796239,-34.6784772465262,-34.6198333096087,-34.5683636287486,-34.4723408422344,-34.5175342544449,-34.5000115510215,-33.9533188162427];
% 
% PrxreqdBm_sim_1pol_400ps = [-35.0528195898155,-34.8747112653844,-34.7271075669014,-34.5111186730979,-34.4518299046902,-34.3525012659038,-34.2781118487042,-34.1421958870582,-34.0476151553779,-33.9164381909142,-33.6742735629284;-35.0528195898155,-34.9424897866684,-34.8107976145044,-34.7755761138654,-34.5771854947010,-34.4965582059244,-34.4959335376108,-34.3444218541929,-34.3050541681067,-34.3886450494406,-34.3024107680074];
% PrxreqdBm_sim_2pol_400ps = [-35.0528195898155,-34.9469396590113,-34.7327631765450,-34.5168589964867,-34.3399542606843,-34.3568517789391,-34.2660204932941,-33.9485436727430,-33.9407477454195,-34.1166829015118,-33.7708563201725;-35.0528195898155,-35.0349688254820,-34.7508801958694,-34.7002269466651,-34.5677554090999,-34.4014879745414,-34.3181979415492,-34.0892056563522,-34.1632307002980,-34.0750761452912,-34.3261549637724];

%% BERtarget = 1.8e-4
PrxreqdBm_sim_1pol_200ps = [-33.7568543356963,-33.4144863343955,-33.3560796656632,-33.2240882178380,-32.8997299311060,-33.0926423180134,-32.9281003655659,-32.7944228772677,-32.6658656773080,-32.5536180425341,-32.5091508056068;-33.7568543356963,-33.4964021332317,-33.3531576373747,-33.2821085619065,-33.1532834975521,-33.1722278401910,-33.1089745475579,-32.9326580665056,-32.7829060179932,-32.7218532314027,-32.6537638433014];
PrxreqdBm_sim_2pol_200ps = [-33.7568543356963,-33.2787326076154,-33.2539068510371,-33.1266261226035,-33.0348971080981,-32.8024583561056,-32.5616155878530,-32.4068039018090,-32.3703265102843,-32.1467345784369,-32.0867664369898;-33.7568543356963,-33.4390632328829,-33.1268313430039,-32.9785208820970,-33.1048960758787,-32.9577380269151,-32.8443976348539,-32.7013505264218,-32.8099286269006,-32.5899658387921,-31.6759995042541];

PrxreqdBm_sim_1pol_400ps = [-33.8145225948464,-33.3656633486190,-33.2143574298784,-33.0539564044703,-32.8920365059379,-32.7927916660063,-32.4279835446653,-32.4122247434566,-31.9553078688746,-31.7920314073379,-31.4294955160951;-33.8145225948464,-33.5557413258355,-33.2844956152750,-33.1610496159534,-33.0169044455728,-32.9652482083036,-32.4617999491913,-32.5259100729796,-32.4669366027757,-32.2978904821708,-32.0625996651640]
PrxreqdBm_sim_2pol_400ps = [-33.8145225948464,-33.3807861553356,-33.2787568609794,-32.7980613758601,-32.3784723483050,-32.3563955910704,-31.8625728157591,-32.0912130592712,-31.1581751659570,-31.5131599578334,-30.8822060883747;-33.8145225948464,-33.4326273768968,-33.1491307630770,-32.9543478085719,-32.9217843542351,-32.5946555345277,-32.4129656178407,-32.0391775139557,-31.9590501384141,-31.6539265566709,-31.8338541521852];

figure(100), hold on, box on
plot(totalLinewidth/1e3, PrxreqdBm(1, :), 'k', 'LineWidth', 2)
plot(totalLinewidth/1e3, PrxreqdBm_sim_1pol_200ps(1, :), '-b', 'LineWidth', 2)
plot(totalLinewidth/1e3, PrxreqdBm_sim_1pol_200ps(2, :), '-r', 'LineWidth', 2)
plot(totalLinewidth/1e3, PrxreqdBm(2, :), '--k', 'LineWidth', 2)
plot(totalLinewidth/1e3, PrxreqdBm_sim_2pol_200ps(1, :), '--b', 'LineWidth', 2)
plot(totalLinewidth/1e3, PrxreqdBm_sim_2pol_200ps(2, :), '--r', 'LineWidth', 2)
axis([totalLinewidth([1 end])/1e3 -36 -32])
xlabel('Linewidth (kHz)', 'FontSize', 12)
ylabel('Receiver sensitivity (dBm)', 'FontSize', 12)
set(gca, 'FontSize', 12)
legend('Analysis', 'Simulation: XOR-based', 'Simulation: Costas') 
grid on


figure(101), hold on, box on
plot(totalLinewidth/1e3, PrxreqdBm(1, :), 'k', 'LineWidth', 2)
plot(totalLinewidth/1e3, PrxreqdBm_sim_1pol_400ps(1, :), '-b', 'LineWidth', 2)
plot(totalLinewidth/1e3, PrxreqdBm_sim_1pol_400ps(2, :), '-r', 'LineWidth', 2)
plot(totalLinewidth/1e3, PrxreqdBm(2, :), '--k', 'LineWidth', 2)
plot(totalLinewidth/1e3, PrxreqdBm_sim_2pol_400ps(1, :), '--b', 'LineWidth', 2)
plot(totalLinewidth/1e3, PrxreqdBm_sim_2pol_400ps(2, :), '--r', 'LineWidth', 2)
axis([totalLinewidth([1 end])/1e3 -36 -32])
xlabel('Linewidth (kHz)', 'FontSize', 12)
ylabel('Receiver sensitivity (dBm)', 'FontSize', 12)
set(gca, 'FontSize', 12)
legend('Analysis', 'Simulation: XOR-based', 'Simulation: Costas') 
grid on

figure, hold on, box on
plot(totalLinewidth, wnOpt/(2*pi*1e6))
