%% BER vs OSNR for PAM
% Penalties breakdown
clear, clc, close all
addpath ../mpam/
addpath f/

%% Row 1: Nearly ideal system with analog predistortion to compensate for MZM nonlinearity (full swing)
%% Row 2: Nearly ideal system without analog predistortion to compensate for MZM nonlinearity (full swing)
%% Row 3: Nearly ideal system without analog predistortion to compensate for MZM nonlinearity (70% swing)
%% Row 4: Include Modulator bandwidth of 10 GHz as 5th-order Beseel and preemphasis (70% swing)
%% Row 5: Include Modulator bandwidth of 10 GHz as 5th-order Beseel and preemphasis (130% swing)
%% Row 6: Include Modulator bandwidth of 10 GHz (based on preemphasis curves) and preemphasis (130% swing)
%% Row 7: Include Quantization on. DAC = 6 bits (ENOB = resolution - 2). ADC = 5bits (250% swing)


OSNRdB = {[19.3683594020088,20.3641564876108,21.3733694636722,22.3729582464805,23.3503524608627,24.3692034339579,25.3875486283551,26.3701995939117,27.3704812353040,28.3680681429965,29.3908664502409,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [19.3441486180879,20.3269250090545,21.3549092954925,22.3499067496478,23.3293411318721,24.3290319594235,25.3128298002170,26.3381557551013,27.3521949450808,28.3169032542119,29.3398706406989,30.3487100154538,31.3374012696428,32.3031011327669,0,0,0,0,0,0,0,0,0,0,0,0],
    [19.6606372371135,20.6719519875735,21.6721529389381,22.6718587830106,23.6636662688823,24.6568609123126,25.6796818083120,26.6655783953417,27.6561315517088,28.6647788152223,29.6551253217001,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [19.9318317894128,20.9682093667703,21.9674387716579,22.9723437794431,23.9502078298326,24.9530384487034,25.9305079671026,26.9516120744300,27.9538052460956,28.9515684959593,29.9578596045422,30.9524739077041,31.9346542274062,32.9362885160674,33.9469845469002,34.9317204170158,35.9459585191420,36.9248600537099,0,0,0,0,0,0,0,0],
    [19.8271138483794,20.8156872645512,21.8275070447195,22.8192315584570,23.8265780109272,24.8372723289151,25.8268865983773,26.8224517891611,27.8294872370265,28.8362275639063,29.7918810482168,30.8209528650169,31.7983867687732,32.8191141434604,0,0,0,0,0,0,0,0,0,0,0,0],
    [19.9089801338961,20.8798522747815,21.8721708881852,22.8956352462133,23.8679282332213,24.8797957840355,25.8846757623799,26.8843093445903,27.8861242899973,28.8734513936888,29.8611250045776,30.8724060540700,31.8687589197499,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [19.8900801657124,20.8917847751764,21.9019104383051,22.8844338156690,23.8862790730338,24.8959708736679,25.8942666418742,26.8805660373268,27.8820319109427,28.8835728357970,29.8975483662099,30.8787647077256,31.8735315295083,32.8673316977322,33.8775196202730,34.8507667686379,0,0,0,0,0,0,0,0,0,0],
    [22.6108617168748,23.6168200931815,24.5997585631639,25.6236093216255,26.6233815063683,27.6082650309562,28.6063203774045,29.6291275882532,30.6193111383747,31.5954534440107,32.6212523565348,33.5714357942587,34.6091872821330,0,0,0,0,0,0,0,0,0,0]};
    
    
%
BER.count = {[0.0279571202338896,0.0177679550319336,0.00989332265979848,0.00521204949271705,0.00246245410089971,0.00119207141987018,0.000382855054556845,0.000121817517358996,6.09087586794981e-05,8.70125123992830e-06,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];...
[0.0357882463498251,0.0256947949115083,0.0193080765014009,0.0133390181508101,0.00890138001844665,0.00590814959191132,0.00362842176705010,0.00159232897690688,0.000861423872752902,0.000287141290917634,8.70125123992830e-05,6.09087586794981e-05,8.70125123992830e-06,0,0,0,0,0,0,0,0,0,0,0,0,0];...
[0.0373457703217723,0.0250683048222334,0.0166454936219828,0.00985851765483877,0.00584724083323182,0.00324556671249326,0.00132259018846910,0.000678697596714408,0.000234933783478064,7.83112611593547e-05,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];...
[0.223857090649635,0.224692410768669,0.208638602231001,0.196221916711623,0.0966709012756034,0.0712893514087326,0.0447505351269513,0.0305065868471886,0.0200737866105146,0.00984981640359884,0.00536867201503576,0.00253206411081914,0.000643892591754694,0.000330647547117275,0.000165323773558638,1.74025024798566e-05,8.70125123992830e-06,0,0,0,0,0,0,0,0,0];...
[0.0767015296799680,0.0540434714511947,0.0390860205697579,0.0220315681394985,0.0130344743574126,0.00703061100186207,0.00356751300837060,0.00156622522318709,0.000765710109113691,0.000261037537197849,6.96100099194264e-05,2.61037537197849e-05,8.70125123992830e-06,0,0,0,0,0,0,0,0,0,0,0,0,0];...
[0.124758540278092,0.0753615369890190,0.0494318082940327,0.0327515096670901,0.0195082052799193,0.00974540138871970,0.00595165584811096,0.00258427161825871,0.00116596766615039,0.000339348798357204,6.09087586794981e-05,1.74025024798566e-05,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
[0.0104513044821503,0.00661387490955211,0.00400003252058960,0.00187806404930121,0.00105691916194441,0.000548784949471134,0.000211383832388881,9.75617687948682e-05,3.65856632980756e-05,1.62602947991447e-05,4.06507369978618e-06,8.13014739957235e-06,0,0,0,0,0,0,0,0,0,0,0]};


% 
BER.gauss = {[0.0157165631807584,0.0103361356301440,0.00709619551112609,0.00436235785609286,0.00199451344047912,0.00107813336219837,0.000480999830198154,0.000157138429652339,5.27523365285241e-05,8.09953295881651e-06,1.52947810029398e-06,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
[0.0159967622912845,0.0109548954192975,0.00675872651662514,0.00416078356400629,0.00227755772739337,0.00111852621170475,0.000411219624140330,0.000166267995722813,5.25721544345637e-05,9.47395402647739e-06,2.89149510037551e-06,2.19586227263723e-07,2.43304703001740e-08,8.43479845158951e-10,0,0,0,0,0,0,0,0,0,0,0,0];
[0.0158582893664693,0.00980615616684371,0.00594055344899088,0.00359525149950066,0.00187394515253431,0.000940055070706220,0.000300743742061655,0.000113028224856159,3.84922758844857e-05,8.60526645220074e-06,1.35244129626856e-06,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
[0.0502188623348019,0.0373448388507487,0.0466285928166916,0.0382664852948141,0.0125158965847390,0.0116757315461044,0.00536264474944626,0.00312647582985175,0.00117299851303582,0.000360517070856926,9.73566312179397e-05,2.56283530983149e-05,2.66378444681163e-06,5.05023630407879e-07,4.17184273855261e-08,9.23123493772299e-10,2.71310720378080e-11,3.06408453563634e-13,0,0,0,0,0,0,0,0];
[0.0125867067448769,0.00728279838132111,0.00725283542264990,0.00222952442752075,0.00118680429321499,0.000521159987848555,0.000204500292403947,5.32647794414210e-05,1.50008943348357e-05,1.86505127528587e-06,1.39915747774886e-07,1.50197391237061e-08,4.38569706683872e-10,1.10614925358456e-11,0,0,0,0,0,0,0,0,0,0,0,0];
[0.0313875601220908,0.0219539964399784,0.0161345405178216,0.00855798386698939,0.00444380915717273,0.00246173820780430,0.00113841247297916,0.000363398359435404,0.000117545986341162,3.47100636162958e-05,6.95265792912497e-06,1.78625100793914e-06,9.37836514254364e-08,0,0,0,0,0,0,0,0,0,0,0,0,0];
[0.00292780113104294,0.00125001529333364,0.000669951631043131,0.000236280116187318,6.33593981797379e-05,1.70900971498454e-05,2.77712075525163e-06,2.76559812960569e-07,2.18526893616792e-08,8.51763779969471e-10,1.03645171740970e-11,8.09542284170714e-14,2.85165174381030e-16,0,0,0,0,0,0,0,0,0,0]};

OSNRdBexp = [25,26,27,28,29,30,31,32,34,36,39,43,48];
BER.exp = [0.00236459514949504,0.00134356948798948,0.000753756517317816,0.000367979274457639,0.000183607356782545,0.000138263029803860,4.52555156087015e-05,2.67081731461189e-05,5.19325588952313e-06,2.97339849040559e-06,7.41893698503304e-07,0,0];


mpam = PAM(4, 56e9);

figure, hold on, box on
n = 1;
for k = [1 3 7]
    hline(n) = plot(OSNRdB{k}, log10(BER.count{k}), '-o', 'LineWidth', 2);
    if k == 1 || k == 3
        plot(OSNRdB{k}, log10(BER.gauss{k}), '-', 'Color', get(hline(n), 'Color'), 'LineWidth', 2);   
    end
    n = n + 1;
end
OSNRdBanalytic = linspace(25, 48);
hline(n) = plot(OSNRdBanalytic, log10(pam_ber_from_osnr(mpam.M, OSNRdBanalytic, mpam.Rs/2, -Inf)), ':k', 'LineWidth', 2);
hline(n+1) = plot(OSNRdBexp, log10(BER.exp), '-ok', 'LineWidth', 2);
leg= legend(hline, {'DAC waveform predistortion', 'No predistortion', 'Simulation', 'AWGN limit', 'Experiment'});
set(leg, 'FontSize', 12)
set(gca, 'FontSize', 12)
axis([OSNRdB(1) OSNRdB(find(OSNRdB ~= 0, 1, 'last')) -8 0])
xlabel('OSNR (dB)', 'FontSize', 12)
ylabel('log_{10}(BER)', 'FontSize', 12)
set(gca, 'FontSize', 12)
axis([20 35 -8 0])
grid on
drawnow    


