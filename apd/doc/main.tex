\documentclass[a4paper]{article}

\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage[numbered]{bookmark}
\usepackage[colorinlistoftodos]{todonotes}

\title{APD Analysis and Simulations}

\author{JKP}

\date{\today}

\begin{document}
\maketitle

\input{common-part}

\section{APD}
\subsection{Output signal statistics}

Given an input average optical power $\bar{P}$, the number of $m$ primary electrons is Poisson distributed \cite{personick}: $m \sim \mathrm{Poisson}(\lambda)$, where $\lambda = (RP + I_d)dt/q$, $R$ is the photodiode responsivity; $I_d$ is the dark current; $dt$ is the sampling time of the received signal (sampling here means that the input signal is assumed to occur in discrete times); and $q$ is the electron charge.

The probability generating function (pgf) of the primaries distribution $p_1(m|P)$ is given by
\begin{equation}
g(z) = \sum_{r = 0}^{\infty} p_1(m|P)z^r = e^{\lambda(z-1)}
\end{equation}

Personick \cite{personick-comp-4methos} showed that the PGF of secondary electrons $p_2(n|1)$ (probability of generating $n$ secondary electrons from 1 primary) is
\begin{equation}
M(z) = \sum_{n = 0}^{\infty} p_2(n|1)z^n
\end{equation}
with $z = M[1 + \alpha(M-1)]^{-\beta}, \beta= (1-k)^{-1} > 1, \text{and}~G = (1-\alpha\beta)^{-1}.$

Later Balaban, Fleisher, and Zucker \cite{gain-distribution} showed that $p_2(n|m) \sim M(z)^m$, where $p_2(n|1) \sim M(z)$. That is, the gain of each primary electron is independent.
Therefore the probability of having $n$ output electrons for a given input optical power $P$ is

\begin{equation} \label{output-probability}
p(n|P) = \sum_{m = 0}^{\infty} p_2(n|m)p_1(m|P) =  \sum_{m = 0}^{\infty} p_2(n|m) \frac{\lambda^m e^{\lambda}}{m!}
\end{equation}
whose pgf is given by
\begin{align}
f(z) &= \sum_{k = 0}^{\infty}p(n|P)z^k = \sum_{k=0}^{\infty}\bigg(\sum_{m=0}^{\infty}p_1(m|P)p_2(n|m)\bigg)z^k \\ \nonumber
& = \sum_{m=0}^{\infty}p_1(m|P)\bigg(\sum_{k=0}^{\infty}p_2(n|m)z^k\bigg) \\ \nonumber
& = \sum_{m=0}^{\infty}p_1(m|P)M(z)^m \\
& = g(M(z)) = e^{\lambda(M(z)-1)}
\end{align}

From \cite{ber-saddlepoint-approx}, the pmf and its tails are given by
\begin{align}
p(n|P) = \frac{1}{2\pi j}\oint_C z^{-(n+1)}f(z)dz \\
p(N \geq n| P) = \frac{1}{2\pi j}\oint_{C+} \frac{z^{-n}}{z-1}f(z)dz \\
p(N \leq n| P) = \frac{1}{2\pi j}\oint_{C-} \frac{z^{-n}}{1-z}f(z)dz
\end{align}

We can apply the saddlepoint approximation to the inversion formulas: 

\subsection{pdf and tail probabilities including thermal noise and using the saddlepoint approximation}
\subsubsection{pdf}
The MGF of the signal including thermal noise with variance $\sigma^2$ is given by
\begin{equation}
\Phi (s) = \exp\Big(\lambda (M(e^s) - 1) + \frac{1}{2}\sigma^2s^2\Big)
\end{equation}

Thus, from the inversion equation we can write
\begin{align}
& K(s,x) = \log (\Phi(s)) - sx = \lambda (M(e^s) - 1) + \frac{1}{2}\sigma^2s^2 - sx \\
&\frac{\partial K(s,x)}{\partial s} = \lambda \frac{d}{ds}M(e^s) + \sigma^2s - x \\
&\frac{\partial^2 K(s,x)}{\partial s^2} = \lambda \frac{d^2}{ds^2}M(e^s) + \sigma^2
\end{align}

The main difficulty in evaluating the derivatives of $K(s,x)$ is in the fact that $M(e^s)$ has no explicit relation; it is only given in terms of the implicit relation
\begin{equation}
e^s = z = M(1 + \alpha(M-1))^{-\beta}
\end{equation}
where $\beta = (1 - k)^{-1}$, and $G = (1-\alpha\beta)^{-1}$.

Thus, we can write
\begin{align}
&\frac{d}{ds}M(s) = \frac{M(1 + \alpha (M-1))}{1 + \alpha(M-1) - \alpha\beta M} = \frac{p(s)}{q(s)}\\
&\frac{d^2}{ds^2}M(s) = \frac{p'q - pq'}{q^2}
\end{align}
where $p'(s) = M'(1 + \alpha(2M-1))$, and $q'(s) = \alpha M'(1 - \beta)$.

\begin{align}
&\frac{\partial K(s,x)}{\partial s} = \lambda \frac{M(1 + \alpha (M-1))}{1 + \alpha(M-1) - \alpha\beta M} + \sigma^2\log\Big(M(1 + \alpha(M-1))^{-\beta}\Big) - x \\
\end{align}

\subsubsection{tail}
Similarly for the tail probabilities, the MGF of the signal including thermal noise with variance $\sigma^2$ is given by
\begin{equation}
\Phi (s) = \exp\Big(\lambda (M(e^s) - 1) + \frac{1}{2}\sigma^2s^2\Big)
\end{equation}

Thus, from the inversion equation we can write
\begin{align}
& K(s,x) = \log \Big(\frac{\Phi(s)}{s}\Big) - sx = \lambda (M(e^s) - 1) + \frac{1}{2}\sigma^2s^2 - sx - \log(|s|) \\
&\frac{\partial K(s,x)}{\partial s} = \lambda \frac{d}{ds}M(e^s) + \sigma^2s - x - \frac{1}{s} \\
&\frac{\partial^2 K(s,x)}{\partial s^2} = \lambda \frac{d^2}{ds^2}M(e^s) + \sigma^2 + \frac{1}{s^2} 
\end{align}

The derivatives of $M(e^s)$ remain the same, and we can write

\begin{align}
&\frac{\partial K(s,x)}{\partial s} = \lambda \frac{M(1 + \alpha (M-1))}{1 + \alpha(M-1) - \alpha\beta M} + \sigma^2\log\Big(M(1 + \alpha(M-1))^{-\beta}\Big) - x -\frac{1}{s}
\end{align}

\subsection{Gaussian approximation}
The Gaussian approximation is equivalent to modeling equation \eqref{output-probability} as a Gaussian random variable \cite{personick-comp-4methos}. This approximation is fairly accurate because even for small power levels such as $-30$ dB, we have $\lambda = 125$, assuming a rate of 50 GHz.

The current is equal to $I = \frac{nq}{dt} = \frac{n}{\lambda}(RP + I_d)$, where $n \sim p(n|P)$ as in \eqref{output-probability}. Thus, 
\begin{align}
& E(I) = RP + I_d \\
& \mathrm{Var}(I) = G^2F_A(G)\cdot 2q(RP_{rec} + I_d)1/dt
\end{align}
where $F_A(G)G^2$ corresponds to the mean square value of the random gain \cite{personick-comp-4methos}.

\textbf{Excess noise factor}
\begin{equation}
F_A(G) = k_AG + (1-k_A)\Big(2 - \frac{1}{G}\Big)
\end{equation}

\textbf{One-sided shot noise psd}
\begin{equation}
S_{shot} = G^2F_A(G)\cdot 2q(RP_{rec} + I_d)
\end{equation}

\textbf{APD noise figure:} The noise figure is defined as the $F_n = SNR_{in}(dB) - SNR_{out}(dB)$, where $SNR_{in}$ is defined as the SNR assuming only shot noise in a ideal photo counter, and $SNR_{out}(dB)$ is the SNR assuming the detection with the APD.

\underline{The excess noise factor is equal to the APD noise figure}, where the noise figure is defined as the ratio between the $SNR_{in}$ assuming detection with a photodiode with no dark current, and $SNR_{out}$ assuming detection with an APD with no dark current.
\begin{align}
F_n &= \frac{SNR_{in}}{SNR_{out}} = \frac{\frac{(R\bar{P})^2}{2qR\bar{P}\Delta f}}{\frac{(GR\bar{P})^2}{G^2F_A(G)\cdot 2qR\bar{P}\Delta f}} = F_A(G)
\end{align}

\subsection{BER}

\begin{align} \label{eq:error-prob} \nonumber
SER = p(\mathcal{E}) = &\frac{1}{M}Q\bigg(\frac{GR(b_1 - a_0)}{\sigma_{0}}\bigg) \\ \nonumber 
& + \frac{1}{M}\sum_{k=1}^{M-2}\Bigg[Q\bigg(\frac{GR(a_k-b_k)}{\sigma_{k}}\bigg) + Q\bigg(\frac{GR(b_{k+1}-a_k)}{\sigma_{k}}\bigg)\Bigg] \\
& + \frac{1}{M}Q\bigg(\frac{GR(a_{M-1}-b_{M-1})}{\sigma_{M-1}}\bigg)
\end{align}
where $\sigma_{k}^2$ is the noise variance of the $i$th level:
\begin{equation}
\sigma_{k}^2 = \sigma_{th}^2 + G^2F_A(G)\cdot 2q(RP_{k} + I_d)R_s + RIN\cdot (RGP_{k})^2R_s 
\end{equation}


In the case of equally-spaced levels:
\begin{equation}
SER = \frac{1}{M}Q\bigg(\frac{\Delta P}{\sigma_{0}}\bigg) + \frac{2}{M}Q\bigg(\frac{\Delta P}{\sigma_{1}}\bigg) + \ldots + \frac{1}{M}Q\bigg(\frac{\Delta P}{\sigma_{M-1}}\bigg)
\end{equation}
where $\Delta P = \frac{2\bar{P}}{M-1}\frac{1-r_{ex}}{1 + r_{ex}}$ is the level spacing.

The BER can be calculated by assuming Gray coding:
\begin{equation}
BER = \frac{SER}{\log_2 M}
\end{equation}

When shot noise or RIN are dominant the BER is dominated by the BER of the last level. Thus, we can write
\begin{align}
BER \approx \frac{1}{M\log_2 M}Q\bigg(\frac{\Delta P}{\sigma_{M-1}}\bigg)
\end{align}

\section{Gain and Level Spacing Optimization}

\subsection{Equally-spaced levels}
Since for equally-spaced levels the BER is dominated by the BER of the highest level, we can optimize the gain by optimizing the SNR of the last level. Thus,
\begin{align} \nonumber
G_{opt} &= \arg\max_{G} \frac{\Delta P^2}{\sigma_{th}^2 + G^2F_A(G)\cdot 2q(RP_{M-1} + I_d)R_s + RIN\cdot (RGP_{M-1})^2R_s} \\ \nonumber
& = \arg\max_{G}\frac{G^2P^2_{M-1}\frac{(1-r_{ex})^2}{(M-1)^2}}{\sigma_{th}^2 + G^2F_A(G)\cdot 2q(RP_{M-1} + I_d)R_s + RIN\cdot (RGP_{M-1})^2R_s} \\ \nonumber
& = \arg\max_{G}\frac{G^2P^2_{M-1}\frac{(1-r_{ex})^2}{(M-1)^2}}{\sigma_{th}^2 + G^2\Big(k_AG + (1-k_A)\Big(2 - \frac{1}{G}\Big)\Big)\cdot 2q(RP_{M-1} + I_d)R_s + RIN\cdot (RGP_{M-1})^2R_s} \\ \nonumber
& = \arg\max_{G}\frac{G^2P^2_{M-1}\frac{(1-r_{ex})^2}{(M-1)^2}}{\sigma_{th}^2 + \Big(k_AG^3 + 2(1-k_A)G^2 - (1-k_A)G\Big)\cdot 2q(RP_{M-1} + I_d)R_s + RIN\cdot (RGP_{M-1})^2R_s} \\
& = \arg\max_{G}\frac{aG^2}{bG^3 + cG^2 + dG + e}
\end{align}
where $P_{M-1}$ refers to the optical power of the highest level before the APD.

\begin{align}
& a = P^2_{M-1}\frac{(1-r_{ex})^2}{(M-1)^2} \\
& b = 2qk_A(RP_{M-1} + I_d)R_s \\
& c = 2(1-k_A) + RIN\cdot (RP_{M-1})^2R_s \\
& d = -2q(1-k_A)(RP_{M-1} + I_d)R_s \\
& e = \sigma_{th}^2 
\end{align}

\begin{align}
& \frac{\partial}{\partial G}\bigg(\frac{aG^2}{bG^3 + cG^2 + dG + e}\bigg) = 0 \\
& bG^3 = dG + 2e 
\end{align}

\subsection{Optimized level spacing}

One heuristic to minimize \eqref{eq:error-prob} is to make all error events equally likely. That is,
\begin{align} \label{eq:level-opt-condition} \nonumber
Q\bigg(\frac{GR(b_1 - a_0)}{\sigma_{0}}\bigg) =& \ldots = Q\bigg(\frac{GR(a_k-b_k)}{\sigma_{k}}\bigg) = Q\bigg(\frac{GR(b_{k+1}-a_k)}{\sigma_{k}}\bigg) = \ldots = Q\bigg(\frac{GR(a_{M-1}-b_{M-1})}{\sigma_{M-1}}\bigg) \\
& \frac{GR(b_k-a_{k-1})}{\sigma_{k-1}} = \frac{GR(a_{k}-b_k)}{\sigma_{k}} = \xi,~k = 1, \ldots, M-1
\end{align}

where $\xi$ depends on the target BER 
This way the BER is given by
\begin{equation}
\xi = \frac{M\log_2 M}{2(M-1)}Q^{-1}(BER)
\end{equation}

From \eqref{eq:level-opt-condition} we have the following equations
\begin{equation}
\begin{cases}
b_k - a_{k-1} = \sigma_{k-1}\frac{\xi}{GR} \\
a_k - b_k = \sigma_{k}\frac{\xi}{GR}
\end{cases}, k = 1, \ldots, M-1
\end{equation}

Solving for $a_k$
\begin{equation}
a_k = a_{k-1} + \frac{\xi}{GR}(\sigma_{k-1} + \sigma_k)
\end{equation}

\subsection{Power Penalty vs Noise Figure}

Shot noise is dominant, and the BER is determined by the argument of the Q-function
\begin{equation}
\frac{\Delta P}{\sigma_{shot}} \propto \frac{GP}{\sqrt{G^2F_A(G)P}} = \sqrt{\frac{P}{F_A(G)}}
\end{equation}
Thus, 1-dB increase in the noise figure corresponds in 1-dB power penalty. However, for APD the noise figure depends on the operation point i.e., Gain.


\section{Frequency Response}

When the avalanche build-up time dominates the frequency response we have \cite{}

\begin{equation}
G_{APD}(f) = \frac{1}{1 + (2\pi fMt_i)^2}
\end{equation}
where $M$ is the APD gain, and $t_i$ is the intrinsic response time given by \eqref{eq:ti}, which is a scattering limited transit time of carrier in the avalanche region. The product $t_iM$ is called the avalanche build-up time \cite{frequency-reponse-InP-InGaAs}.

\begin{equation}
t_i = Nk_a\frac{l_a}{\nu}
\end{equation}
where $N$ is a slowly varying factor from $1/3$ to 2, $l_a$ is the avalanche region width, and $\nu$ is the effective carrier drift velocity in the avalanche region.

\begin{thebibliography}{9}
\bibitem{personick-comp-4methos} Personick, S. D., Balaban, P., Bobsin, J. H., and Kumar, P.; ``R.A Detailed Comparison of Four Approaches to the Calculation of the Sensitivity of Optical Fiber System Receivers,'' \emph{IEEE Transactions on Communications}, 1976.

\bibitem{gain-distribution} Balaban, P., Fleischer, P. E., and Zucker, H.; ``The Probability Distribution of Gains in Avalanche Photodiodes,'' \emph{IEEE Transactions on Electron Devices}, 1976.

\bibitem{ber-saddlepoint-approx} Carl Helstrom; ``Performance Analysis of Optical Receivers by the Saddlepoint Approximation,'' \emph{IEEE Transactions on Communications}, 1979.

\bibitem{personick} Personick, S. D.; ``Statistics of a General Class of Avalanche Detectors With Applications to Optical Communication,'' \emph{The Bell SystemTechnical Journal}, 1971.

\bibitem{agilent-RIN-measurement} Product Note 86100-7; ``Digital Communication Analyzer (DCA), Measure Relative Intensity Noise (RIN),'' Agilent Technologies. 

\bibitem{frequency-reponse-InP-InGaAs} Yasuda, K. and Mikawa, T. and Kishi, Y. and Kaneda, T.; ``Multiplication-dependent frequency responses of InP/ InGaAs Avalanche Photodiodes,'' 1981.



\end{thebibliography}

\end{document}